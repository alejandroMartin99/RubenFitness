<div class="client-details-page">
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Cargando detalles del usuario...</p>
  </div>

  <div *ngIf="error" class="error-container">
    <mat-icon>error_outline</mat-icon>
    <p>{{ error }}</p>
    <button mat-stroked-button (click)="loadDetails()">Reintentar</button>
  </div>

  <div *ngIf="!loading && !error && details" class="details-content">
    <!-- Header -->
    <header class="details-header">
      <div>
        <button mat-icon-button (click)="goBack()" class="back-btn">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div>
          <h1>{{ details.user?.full_name || details.profile?.full_name || 'Usuario' }}</h1>
          <p class="subtitle">{{ details.user?.email }}</p>
        </div>
      </div>
      <div class="header-actions">
        <button mat-stroked-button color="primary" (click)="openWhatsApp(details.profile?.phone || '', details.user?.full_name || '')" *ngIf="details.profile?.phone">
          <mat-icon>chat</mat-icon>
          WhatsApp
        </button>
      </div>
    </header>

    <!-- Profile Section -->
    <section class="detail-section">
      <h2>
        <mat-icon>person</mat-icon>
        Perfil completo
      </h2>
      <div class="profile-grid">
        <div class="info-card">
          <span class="label">Nombre completo</span>
          <span class="value">{{ details.profile?.full_name || details.user?.full_name || '-' }}</span>
        </div>
        <div class="info-card">
          <span class="label">G√©nero</span>
          <span class="value">{{ details.profile?.gender || '-' }}</span>
        </div>
        <div class="info-card">
          <span class="label">Fecha de nacimiento</span>
          <span class="value">{{ details.profile?.birth_date || '-' }}</span>
        </div>
        <div class="info-card">
          <span class="label">Altura</span>
          <span class="value">{{ details.profile?.height_cm ? details.profile.height_cm + ' cm' : '-' }}</span>
        </div>
        <div class="info-card">
          <span class="label">Nivel de fitness</span>
          <span class="value">{{ details.user?.fitness_level || '-' }}</span>
        </div>
        <div class="info-card">
          <span class="label">Objetivo</span>
          <span class="value">{{ details.profile?.goal || details.user?.goals?.join(', ') || '-' }}</span>
        </div>
        <div class="info-card">
          <span class="label">Frecuencia de entrenamiento</span>
          <span class="value">{{ details.profile?.training_frequency || '-' }}</span>
        </div>
        <div class="info-card">
          <span class="label">Nivel de actividad</span>
          <span class="value">{{ details.profile?.activity_level || '-' }}</span>
        </div>
        <div class="info-card full-width">
          <span class="label">Notas</span>
          <span class="value">{{ details.profile?.notes || '-' }}</span>
        </div>
      </div>
    </section>

    <!-- Stats Overview -->
    <section class="detail-section">
      <h2>
        <mat-icon>bar_chart</mat-icon>
        Resumen estad√≠stico
      </h2>
      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-label">Total entrenamientos</span>
          <span class="stat-value">{{ details.workouts?.length || 0 }}</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Racha actual</span>
          <span class="stat-value">{{ details.streak?.current_streak || 0 }} d√≠as</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Racha r√©cord</span>
          <span class="stat-value">{{ details.streak?.longest_streak || 0 }} d√≠as</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Logros desbloqueados</span>
          <span class="stat-value">{{ details.achievements?.length || 0 }}</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Fotos de progreso</span>
          <span class="stat-value">{{ details.photos?.length || 0 }}</span>
        </div>
        <div class="stat-card">
          <span class="stat-label">Conversaciones</span>
          <span class="stat-value">{{ details.conversationsCount || 0 }}</span>
        </div>
      </div>
    </section>

    <!-- Charts Section -->
    <section class="detail-section">
      <h2>
        <mat-icon>show_chart</mat-icon>
        Gr√°ficos de evoluci√≥n
      </h2>
      <div class="charts-grid">
        <div class="chart-panel" *ngIf="details.workouts && details.workouts.length > 0">
          <h3>Historial de entrenamientos</h3>
          <div class="chart-container">
            <canvas #workoutsChart></canvas>
          </div>
        </div>
        <div class="chart-panel" *ngIf="details.workouts && details.workouts.length > 0">
          <h3>Volumen por entrenamiento</h3>
          <div class="chart-container">
            <canvas #volumeChart></canvas>
          </div>
        </div>
        <div class="chart-panel" *ngIf="details.bodyComposition && details.bodyComposition.length > 0">
          <h3>Evoluci√≥n composici√≥n corporal</h3>
          <div class="chart-container">
            <canvas #bodyCompChart></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- Workouts Section -->
    <section class="detail-section" *ngIf="details.workouts && details.workouts.length > 0">
      <h2>
        <mat-icon>fitness_center</mat-icon>
        Entrenamientos completos ({{ details.workouts.length }})
      </h2>
      <div class="workouts-list">
        <div class="workout-card" *ngFor="let workout of details.workouts">
          <div class="workout-header">
            <div>
              <span class="workout-date">{{ workout.workout_date | date:'dd/MM/yyyy' }}</span>
              <span class="workout-time" *ngIf="workout.duration_minutes">{{ workout.duration_minutes }} min</span>
            </div>
            <div class="workout-meta">
              <span class="badge" *ngIf="workout.total_volume">Vol: {{ formatVolume(workout.total_volume) }} kg</span>
              <span class="badge" *ngIf="workout.satisfaction_rating">‚≠ê {{ workout.satisfaction_rating }}/5</span>
            </div>
          </div>
          <div class="workout-content" *ngIf="workout.notes">
            <div *ngIf="workout.parsedNotes; else rawNotes">
              <div *ngIf="workout.parsedNotes.type" class="workout-type">
                <strong>Tipo:</strong> {{ workout.parsedNotes.type }}
              </div>
              <div *ngIf="workout.parsedNotes.exercises && workout.parsedNotes.exercises.length > 0" class="exercises-list">
                <strong>Ejercicios:</strong>
                <div class="exercise-item" *ngFor="let exercise of workout.parsedNotes.exercises">
                  <div class="exercise-name">{{ exercise?.name || 'Sin nombre' }}</div>
                  <div class="exercise-sets" *ngIf="exercise?.sets && exercise.sets.length > 0">
                    <div class="set-item" *ngFor="let set of exercise.sets; let i = index">
                      Serie {{ i + 1 }}: {{ set?.reps || 0 }} reps √ó {{ set?.weight || 0 }} kg
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <ng-template #rawNotes>
              <div class="workout-notes">
                <pre>{{ workout.formattedNotes || workout.notes }}</pre>
              </div>
            </ng-template>
          </div>
        </div>
      </div>
    </section>

    <!-- Body Composition Section -->
    <section class="detail-section" *ngIf="details.bodyComposition && details.bodyComposition.length > 0">
      <h2>
        <mat-icon>straighten</mat-icon>
        Evoluci√≥n composici√≥n corporal ({{ details.bodyComposition.length }} registros)
      </h2>
      
      <!-- Evolution Summary -->
      <div class="evolution-summary" *ngIf="getBodyCompEvolution() as evolution">
        <h3>Evoluci√≥n desde la primera medici√≥n</h3>
        <div class="evolution-stats">
          <div class="evolution-item" *ngIf="evolution.weight">
            <span class="evolution-label">Peso:</span>
            <span class="evolution-value" [class.positive]="evolution.weight.isPositive" [class.negative]="!evolution.weight.isPositive">
              {{ evolution.weight.value > 0 ? '+' : '' }}{{ formatNumber(evolution.weight.value) }} kg
              ({{ evolution.weight.percent }}%)
            </span>
          </div>
          <div class="evolution-item" *ngIf="evolution.fat">
            <span class="evolution-label">% Grasa:</span>
            <span class="evolution-value" [class.positive]="evolution.fat.isPositive" [class.negative]="!evolution.fat.isPositive">
              {{ evolution.fat.value > 0 ? '+' : '' }}{{ formatNumber(evolution.fat.value) }}%
              ({{ evolution.fat.percent }}%)
            </span>
          </div>
          <div class="evolution-item" *ngIf="evolution.muscle">
            <span class="evolution-label">M√∫sculo:</span>
            <span class="evolution-value" [class.positive]="evolution.muscle.isPositive" [class.negative]="!evolution.muscle.isPositive">
              {{ evolution.muscle.value > 0 ? '+' : '' }}{{ formatNumber(evolution.muscle.value) }} kg
              ({{ evolution.muscle.percent }}%)
            </span>
          </div>
        </div>
      </div>
      
      <div class="body-comp-list">
        <div class="body-comp-card" *ngFor="let comp of details.bodyComposition">
          <div class="comp-date">{{ comp.date | date:'dd/MM/yyyy' }}</div>
          <div class="comp-values">
            <div class="comp-item" *ngIf="comp.weight">
              <span class="label">Peso</span>
              <span class="value">{{ formatNumber(comp.weight) }} kg</span>
            </div>
            <div class="comp-item" *ngIf="comp.fat">
              <span class="label">% Grasa</span>
              <span class="value">{{ formatNumber(comp.fat) }} %</span>
            </div>
            <div class="comp-item" *ngIf="comp.muscle">
              <span class="label">M√∫sculo</span>
              <span class="value">{{ formatNumber(comp.muscle) }} kg</span>
            </div>
          </div>
          <div class="comp-notes" *ngIf="comp.notes">{{ comp.notes }}</div>
        </div>
      </div>
    </section>

    <!-- Progress Photos Section -->
    <section class="detail-section" *ngIf="details.photos && details.photos.length > 0">
      <h2>
        <mat-icon>photo_library</mat-icon>
        Fotos de progreso ({{ details.photos.length }})
      </h2>
      <div class="photos-grid">
        <div class="photo-card" *ngFor="let photo of details.photos">
          <div class="photo-badge" [class.before]="photo.photo_type === 'before'" [class.after]="photo.photo_type === 'after'">
            {{ photo.photo_type === 'before' ? 'Antes' : 'Despu√©s' }}
          </div>
          <img [src]="(photo.photo_url || photo.thumbnail_url) || ''" [alt]="photo.photo_type || 'Foto'" (error)="onImageError($event)" />
          <div class="photo-info">
            <div class="photo-date">{{ photo.taken_at | date:'dd/MM/yyyy' }}</div>
            <div class="photo-measurements" *ngIf="photo.measurements">
              <div *ngIf="photo.measurements?.weight">Peso: {{ photo.measurements.weight }} kg</div>
              <div *ngIf="photo.measurements?.bodyFat">Grasa: {{ photo.measurements.bodyFat }} %</div>
            </div>
            <div class="photo-notes" *ngIf="photo.notes">{{ photo.notes }}</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Achievements Section -->
    <section class="detail-section" *ngIf="details.achievements && details.achievements.length > 0">
      <h2>
        <mat-icon>emoji_events</mat-icon>
        Logros ({{ details.achievements.length }})
      </h2>
      <div class="achievements-grid">
        <div class="achievement-card" *ngFor="let achievement of details.achievements">
          <div class="achievement-icon">{{ achievement.icon || 'üèÜ' }}</div>
          <div class="achievement-info">
            <div class="achievement-title">{{ achievement.title }}</div>
            <div class="achievement-desc">{{ achievement.description }}</div>
            <div class="achievement-date">{{ achievement.unlocked_at | date:'dd/MM/yyyy' }}</div>
            <div class="achievement-progress" *ngIf="achievement.progress && achievement.target">
              Progreso: {{ achievement.progress }} / {{ achievement.target }}
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Health Data Section -->
    <section class="detail-section" *ngIf="details.healthData && details.healthData.length > 0">
      <h2>
        <mat-icon>favorite</mat-icon>
        Datos de salud (√∫ltimos 30 d√≠as)
      </h2>
      <div class="health-list">
        <div class="health-card" *ngFor="let health of details.healthData">
          <div class="health-header">
            <div class="health-date">{{ health.date | date:'dd/MM/yyyy' }}</div>
          </div>
          <div class="health-metrics">
            <div class="health-metric" *ngIf="health.sleep_hours">
              <mat-icon class="metric-icon sleep">bed</mat-icon>
              <div class="metric-content">
                <span class="metric-label">Sue√±o</span>
                <span class="metric-value">{{ health.sleep_hours }}h</span>
              </div>
            </div>
            <div class="health-metric" *ngIf="health.water_ml">
              <mat-icon class="metric-icon water">water_drop</mat-icon>
              <div class="metric-content">
                <span class="metric-label">Agua</span>
                <span class="metric-value">{{ formatWater(health.water_ml) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Habits Section -->
    <section class="detail-section" *ngIf="details.habits && details.habits.length > 0">
      <h2>
        <mat-icon>check_circle</mat-icon>
        H√°bitos ({{ details.habits.length }})
      </h2>
      <div class="habits-list">
        <div class="habit-card" *ngFor="let habit of details.habits">
          <div class="habit-name">{{ habit.name }}</div>
          <div class="habit-desc" *ngIf="habit.description">{{ habit.description }}</div>
          <div class="habit-target" *ngIf="habit.target_frequency">
            Frecuencia objetivo: {{ habit.target_frequency }} veces/semana
          </div>
            <div class="habit-logs" *ngIf="details.habitLogs">
              <div class="log-item" *ngFor="let log of getHabitLogs(habit.id)">
                <span class="log-date">{{ log.log_date | date:'dd/MM' }}</span>
                <span class="log-status" [class.completed]="log.completed">
                  {{ log.completed ? '‚úì Completado' : '‚úó No completado' }}
                </span>
              </div>
            </div>
        </div>
      </div>
    </section>

    <!-- Workout Days Section -->
    <section class="detail-section" *ngIf="details.workoutDays && details.workoutDays.length > 0">
      <h2>
        <mat-icon>calendar_today</mat-icon>
        D√≠as de entrenamiento (√∫ltimos 90 d√≠as)
      </h2>
      <div class="workout-days-calendar">
        <div class="day-item" *ngFor="let day of details.workoutDays">
          {{ day.date | date:'dd/MM/yyyy' }}
        </div>
      </div>
    </section>
  </div>
</div>

