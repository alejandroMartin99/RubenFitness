<div class="coach-page">
  <header class="page-header">
    <div>
      <p class="eyebrow">Panel admin</p>
      <h1>Seguimiento de usuarios</h1>
      <p class="subtitle">Revisa entrenos, rachas y composición corporal</p>
    </div>
    <div class="actions">
      <button mat-stroked-button color="primary" (click)="loadData()" [disabled]="loading">
        <mat-icon>refresh</mat-icon>
      </button>
      <button mat-flat-button color="primary">Asignar rutina</button>
    </div>
  </header>

  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="40"></mat-spinner>
    <p>Cargando datos...</p>
  </div>

  <div *ngIf="error && !loading" class="error-container">
    <mat-icon>error_outline</mat-icon>
    <p>{{ error }}</p>
    <button mat-stroked-button (click)="loadData()">Reintentar</button>
  </div>

  <div *ngIf="!loading && !error">
    <!-- KPIs Section -->
    <section class="kpi-grid">
      <div class="kpi-card" *ngFor="let k of kpis" [class.positive]="k.trendType === 'positive'" [class.negative]="k.trendType === 'negative'">
        <p class="kpi-label">{{ k.label }}</p>
        <p class="kpi-value">{{ k.value }}</p>
        <p class="kpi-trend" *ngIf="k.trend">
          <mat-icon *ngIf="k.trendType === 'positive'">trending_up</mat-icon>
          <mat-icon *ngIf="k.trendType === 'negative'">trending_down</mat-icon>
          {{ k.trend }}
        </p>
      </div>
    </section>

    <!-- Evolution Charts Section -->
    <section class="charts-grid">
      <div class="panel chart-panel">
        <div class="panel-header">
          <div>
            <h2>Workouts</h2>
            <p>Últimos 30 días</p>
          </div>
        </div>
        <div class="chart-container">
          <canvas #evolutionChart></canvas>
        </div>
      </div>

      <div class="panel chart-panel">
        <div class="panel-header">
          <div>
            <h2>Volumen</h2>
            <p>Últimos 30 días</p>
          </div>
        </div>
        <div class="chart-container">
          <canvas #volumeChart></canvas>
        </div>
      </div>

      <div class="panel chart-panel">
        <div class="panel-header">
          <div>
            <h2>Usuarios activos</h2>
            <p>Últimos 30 días</p>
          </div>
        </div>
        <div class="chart-container">
          <canvas #usersChart></canvas>
        </div>
      </div>
    </section>

    <!-- Users Section -->
    <section class="panel">
      <div class="panel-header">
        <div>
          <h2>Usuarios</h2>
          <p>Estado y objetivos</p>
        </div>
        <div class="search-wrapper">
          <input type="text" class="search-input" [(ngModel)]="search" placeholder="Buscar..." />
          <mat-icon class="search-icon">search</mat-icon>
          <button *ngIf="search" class="search-clear" (click)="search=''" aria-label="Clear">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </div>

      <!-- Mobile Cards -->
      <div class="mobile-cards">
        <div class="mobile-card" *ngFor="let c of filteredClients" (click)="viewClientDetails(c)">
          <div class="mc-row">
            <div class="mc-user">
              <span class="mc-name">{{ c.name }}</span>
              <span class="mc-stats">{{ c.workoutsWeek }}w · {{ c.streak }}d · {{ c.weight ? formatNumber(c.weight) + 'kg' : '-' }}</span>
            </div>
            <div class="mc-actions">
              <button class="mc-btn" (click)="openWhatsApp(c); $event.stopPropagation()" [disabled]="!c.phone" [class.disabled]="!c.phone">
                <mat-icon>phone</mat-icon>
              </button>
              <button class="mc-btn" (click)="openCalendar(c); $event.stopPropagation()" [disabled]="!c.phone" [class.disabled]="!c.phone">
                <mat-icon>event</mat-icon>
              </button>
              <mat-icon class="mc-arrow">chevron_right</mat-icon>
            </div>
          </div>
        </div>
        <div class="list-empty" *ngIf="filteredClients.length === 0">
          <p>Sin usuarios</p>
        </div>
      </div>

      <!-- Desktop Table -->
      <div class="table-scroll" [class.scrollable]="filteredClients.length > 6">
        <div class="table">
          <div class="table-head">
            <span>Usuario</span>
            <span>Último</span>
            <span>Semana</span>
            <span>Volumen</span>
            <span>Racha</span>
            <span>Peso</span>
            <span>Grasa</span>
            <span>Músculo</span>
            <span>Objetivos</span>
            <span></span>
            <span></span>
            <span></span>
          </div>
          <div class="table-row" *ngFor="let c of filteredClients">
            <div>
              <p class="name">{{ c.name }}</p>
              <p class="muted">{{ c.email }}</p>
            </div>
            <div>
              <span>{{ c.lastWorkout }}</span>
              <span class="trend-badge positive" *ngIf="c.workoutsTrend > 0">
                <mat-icon>trending_up</mat-icon>
              </span>
              <span class="trend-badge negative" *ngIf="c.workoutsTrend < 0">
                <mat-icon>trending_down</mat-icon>
              </span>
            </div>
            <div>{{ c.workoutsWeek }}</div>
            <div>
              <span>{{ formatVolume(c.volumeWeek) }}</span>
              <span class="trend-badge positive" *ngIf="c.volumeTrend > 0"><mat-icon>trending_up</mat-icon></span>
              <span class="trend-badge negative" *ngIf="c.volumeTrend < 0"><mat-icon>trending_down</mat-icon></span>
            </div>
            <div>
              <span class="streak-badge" [class.active]="c.streak > 0">{{ c.streak }}d</span>
            </div>
            <div>{{ c.weight ? formatNumber(c.weight) : '-' }}</div>
            <div>{{ c.fat ? formatNumber(c.fat) + '%' : '-' }}</div>
            <div>{{ c.muscle ? formatNumber(c.muscle) : '-' }}</div>
            <div class="tags">
              <span class="tag" *ngFor="let g of c.goals">{{ g }}</span>
              <span class="tag muted" *ngIf="c.goals.length === 0">-</span>
            </div>
            <div class="actions-cell">
              <button mat-icon-button (click)="viewClientDetails(c); $event.stopPropagation()" color="primary">
                <mat-icon>visibility</mat-icon>
              </button>
            </div>
            <div class="actions-cell">
              <button mat-icon-button (click)="openWhatsApp(c); $event.stopPropagation()" color="primary" [disabled]="!c.phone" [class.disabled-muted]="!c.phone">
                <mat-icon>phone</mat-icon>
              </button>
            </div>
            <div class="actions-cell">
              <button mat-icon-button (click)="openCalendar(c); $event.stopPropagation()" color="accent" [disabled]="!c.phone" [class.disabled-muted]="!c.phone">
                <mat-icon>event</mat-icon>
              </button>
            </div>
          </div>
          <div class="table-empty" *ngIf="filteredClients.length === 0">
            <mat-icon>search_off</mat-icon>
            <p>No se encontraron usuarios</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Activity and Body Composition Grid -->
    <section class="grid-2">
      <div class="panel">
        <div class="panel-header">
          <div>
            <h2>Actividad semanal</h2>
            <p>Workouts y volumen</p>
          </div>
        </div>
        <div class="list">
          <div class="list-item" *ngFor="let c of activeClients">
            <div>
              <p class="name">{{ c.name }}</p>
              <p class="muted">{{ c.lastWorkout }}</p>
            </div>
            <div class="badges">
              <span class="pill">{{ c.workoutsWeek }} sesiones</span>
              <span class="pill">{{ formatVolume(c.volumeWeek) }} kg</span>
              <span class="pill success" *ngIf="c.streak > 0">{{ c.streak }}d</span>
            </div>
          </div>
          <div class="list-empty" *ngIf="activeClients.length === 0">
            <p>No hay datos</p>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <div>
            <h2>Composición corporal</h2>
            <p>Última medición</p>
          </div>
        </div>
        <div class="list">
          <div class="list-item" *ngFor="let c of bodyCompClients">
            <div>
              <p class="name">{{ c.name }}</p>
              <p class="muted">Último registro</p>
            </div>
            <div class="pill-set">
              <span class="pill" *ngIf="c.weight">{{ formatNumber(c.weight) }}kg</span>
              <span class="pill" *ngIf="c.fat">{{ formatNumber(c.fat) }}%</span>
              <span class="pill" *ngIf="c.muscle">{{ formatNumber(c.muscle) }}kg</span>
              <span class="pill muted" *ngIf="!c.weight && !c.fat && !c.muscle">Sin datos</span>
            </div>
          </div>
          <div class="list-empty" *ngIf="bodyCompClients.length === 0">
            <p>No hay datos</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Users without activity -->
    <section class="panel" *ngIf="missingActivityClients.length > 0">
      <div class="panel-header">
        <div>
          <h2>Sin actividad reciente</h2>
          <p>Contactar</p>
        </div>
      </div>
      <div class="list-missing">
        <div class="missing-item" *ngFor="let c of missingActivityClients">
          <div>
            <p class="name">{{ c.name }}</p>
            <p class="muted small">{{ c.email }}</p>
          </div>
          <button class="ghost-btn" (click)="openEmail(c)">Email</button>
        </div>
      </div>
    </section>
  </div>
</div>

