<div class="progress-container">
  <!-- Header -->
  <div class="progress-header">
    <h2>
      <mat-icon>bar_chart</mat-icon>
      Your Progress
    </h2>
    <p>Track your fitness journey and celebrate your achievements</p>
  </div>

  <!-- Body Composition block -->
  <mat-card class="panel-card body-comp-card">
    <mat-card-header>
      <mat-card-title>
        <div class="title-row">
          <mat-icon>monitor_weight</mat-icon>
          Composición corporal
        </div>
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="body-comp-top">
        <div class="body-grid">
          <div class="body-item">
            <div class="label">Masa muscular</div>
            <div class="value">{{ bodyComp.muscle }} kg</div>
          </div>
          <div class="body-item">
            <div class="label">Grasa corporal</div>
            <div class="value">{{ bodyComp.fat }} %</div>
          </div>
          <div class="body-item">
            <div class="label">Peso</div>
            <div class="value">{{ bodyComp.weight }} kg</div>
          </div>
        </div>
        <form [formGroup]="bodyCompForm" class="body-form" (ngSubmit)="addBodyComposition()">
          <input class="input" type="date" formControlName="date" />
          <input class="input" type="number" step="0.1" min="0" formControlName="muscle" placeholder="Masa (kg)" />
          <input class="input" type="number" step="0.1" min="0" formControlName="fat" placeholder="Grasa (%)" />
          <input class="input" type="number" step="0.1" min="0" formControlName="weight" placeholder="Peso (kg)" />
          <button mat-raised-button color="primary" type="submit">Guardar medida</button>
        </form>
      </div>

      <div class="body-charts">
        <ng-container *ngIf="bodyCompHistory.length > 0; else noBodyComp">
          <div class="chart-card">
            <div class="chart-title">Masa muscular</div>
            <canvas id="muscleChart"></canvas>
          </div>
          <div class="chart-card">
            <div class="chart-title">Grasa corporal</div>
            <canvas id="fatChart"></canvas>
          </div>
          <div class="chart-card">
            <div class="chart-title">Peso</div>
            <canvas id="weightChart"></canvas>
          </div>
        </ng-container>
        <ng-template #noBodyComp>
          <div class="empty-body-comp">
            <mat-icon>info</mat-icon>
            <p>Registra tu primera medición para ver las gráficas.</p>
          </div>
        </ng-template>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Grid layout: 2 columns -->
  <div class="top-grid">
    <!-- Quick log -->
    <mat-card class="panel-card">
      <mat-card-header>
        <mat-card-title>
          <div class="title-row">
            <mat-icon>playlist_add_check</mat-icon>
            Registrar entrenamiento
          </div>
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="workoutForm" class="log-form simple" (ngSubmit)="submitWorkout()">
          <input class="input" type="date" formControlName="date" />

          <select class="input select" formControlName="type">
            <option *ngFor="let t of workoutTypes" [value]="t">{{ t }}</option>
          </select>

          <div class="exercises-section">
            <div class="exercises-header">
              <div class="title-row small">
                <mat-icon>fitness_center</mat-icon>
                Ejercicios (mín. 1)
              </div>
              <button mat-stroked-button color="primary" type="button" (click)="addExercise()">
                <mat-icon>add</mat-icon>
                Añadir ejercicio
              </button>
            </div>

            <mat-accordion class="exercise-list" formArrayName="exercises" [multi]="false">
              <mat-expansion-panel 
                *ngFor="let ex of exercises.controls; let i = index" 
                [formGroupName]="i"
                class="exercise-panel"
                [expanded]="i === expandedExerciseIndex"
              >
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    <div class="exercise-header">
                      <span class="exercise-index">{{ i + 1 }}</span>
                      <div class="exercise-name-autocomplete">
                        <input 
                          class="exercise-name-input" 
                          type="text" 
                          formControlName="name" 
                          placeholder="Nombre del ejercicio"
                          (click)="onExerciseInputClick(i); $event.stopPropagation()"
                          (focus)="onExerciseInputFocus(i)"
                          (input)="onExerciseNameInput(i, $any($event.target).value || '')"
                          [matAutocomplete]="auto"
                        />
                        <mat-autocomplete 
                          #auto="matAutocomplete"
                          (optionSelected)="onExerciseNameSelected(i, $event.option.value)"
                          class="exercise-autocomplete"
                          [displayWith]="null"
                        >
                          <mat-option *ngFor="let exercise of filteredExercises[i] || []" [value]="exercise">
                            {{ exercise }}
                          </mat-option>
                        </mat-autocomplete>
                      </div>
                    </div>
                  </mat-panel-title>
                  <mat-panel-description>
                    <div class="exercise-summary" *ngIf="getExerciseStats(i).sets > 0">
                      {{ getExerciseStats(i).sets }} series
                      <span *ngIf="getExerciseStats(i).volume > 0">• {{ getExerciseStats(i).volume }} kg</span>
                    </div>
                    <button 
                      mat-icon-button 
                      type="button" 
                      (click)="removeExercise(i); $event.stopPropagation()" 
                      [disabled]="exercises.length === 1"
                      class="remove-exercise-btn-header"
                      matTooltip="Eliminar ejercicio"
                    >
                      <mat-icon>delete</mat-icon>
                    </button>
                  </mat-panel-description>
                </mat-expansion-panel-header>

                <div class="exercise-content">
                  <div class="exercise-content-layout">
                    <!-- Imagen del ejercicio a la izquierda (siempre reservado) -->
                    <div class="exercise-image-container">
                      <img 
                        *ngIf="exerciseImage(ex.get('name')?.value)" 
                        [src]="exerciseImage(ex.get('name')?.value)!" 
                        alt="exercise" 
                        class="exercise-image-large"
                        (error)="$any($event.target).style.display='none'"
                      />
                      <div *ngIf="!exerciseImage(ex.get('name')?.value)" class="exercise-image-placeholder">
                        <mat-icon>fitness_center</mat-icon>
                      </div>
                    </div>
                    
                    <!-- Series a la derecha -->
                    <div class="exercise-sets-col" formArrayName="sets">
                      <div class="sets-grid">
                        <div 
                          class="set-row" 
                          *ngFor="let st of getSets(i).controls; let j = index" 
                          [formGroupName]="j"
                        >
                          <span class="set-label">{{ j + 1 }}</span>
                        <div class="set-inputs">
                          <input 
                            class="input set-input" 
                            type="number" 
                            formControlName="reps" 
                            placeholder="Reps"
                            min="1"
                          />
                          <span class="set-separator">×</span>
                          <input 
                            class="input set-input" 
                            type="number" 
                            formControlName="weight" 
                            placeholder="kg"
                            min="0"
                            step="0.5"
                          />
                        </div>
                        <button 
                          mat-icon-button 
                          type="button" 
                          (click)="removeSet(i, j)" 
                          [disabled]="getSets(i).length === 1"
                          class="remove-set-btn"
                          matTooltip="Eliminar serie"
                        >
                          <mat-icon>close</mat-icon>
                        </button>
                      </div>
                    </div>
                      <button mat-stroked-button color="primary" type="button" (click)="addSet(i)" class="add-set-btn">
                        <mat-icon>add</mat-icon>
                        Añadir serie
                      </button>
                    </div>
                  </div>
                </div>
              </mat-expansion-panel>
            </mat-accordion>
          </div>

          <textarea class="input textarea" rows="3" formControlName="notes" placeholder="Notas (opcional)"></textarea>

          <div class="actions">
            <button mat-raised-button color="primary" type="submit" [disabled]="workoutForm.invalid">Guardar entrenamiento</button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>

    <!-- Visualizer -->
    <div class="right-column">
      <app-body-visualizer [muscles]="selectedMuscles"></app-body-visualizer>
    </div>
  </div>

  <!-- Tabs Navigation -->
  <mat-tab-group class="progress-tabs" animationDuration="300ms">
    <!-- Overview Tab -->
    <mat-tab label="Overview">
      <ng-template matTabContent>
        <!-- Recent Workouts -->
        <div class="recent-workouts" *ngIf="summary">
        <h3 class="section-title">
          <mat-icon>history</mat-icon>
          Recent Workouts
        </h3>

        <!-- No workouts message -->
        <mat-card class="empty-state" *ngIf="!summary.recentWorkouts || summary.recentWorkouts.length === 0">
          <mat-icon>inbox</mat-icon>
          <h4>No workouts yet</h4>
          <p>Start tracking your progress by completing your first workout!</p>
        </mat-card>

        <!-- Workouts list -->
        <mat-accordion class="workouts-accordion" *ngIf="summary.recentWorkouts && summary.recentWorkouts.length > 0">
          <mat-expansion-panel *ngFor="let workout of summary.recentWorkouts; let i = index" class="workout-panel">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <div class="workout-header">
                  <div class="workout-title">{{ workout.name }}</div>
                  <div class="workout-date">
                    <mat-icon>calendar_today</mat-icon>
                    {{ workout.date | date:'fullDate' }}
                  </div>
                </div>
              </mat-panel-title>
              <mat-panel-description>
                <div class="panel-actions">
                  <button mat-icon-button color="primary" (click)="editWorkout(workout, i)" [class.active]="editingWorkoutIndex === i" matTooltip="Editar">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button mat-icon-button color="warn" (click)="deleteWorkout(workout, i)" matTooltip="Eliminar">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </mat-panel-description>
            </mat-expansion-panel-header>

            <div class="workout-body">
              <div class="workout-row" *ngIf="workout.durationMinutes">
                <mat-icon>schedule</mat-icon>
                <span>{{ workout.durationMinutes }} minutos</span>
              </div>
              <div class="workout-row" *ngIf="workout.notes">
                <mat-icon>note</mat-icon>
                <span>{{ workout.notes }}</span>
              </div>
              <div class="workout-row">
                <mat-icon>check_circle</mat-icon>
                <span>Completado</span>
              </div>

              <div class="edit-inline" *ngIf="editingWorkoutIndex === i">
                <div class="edit-grid">
                  <input class="input" type="date" [(ngModel)]="editFields.date" name="editDate{{i}}" />
                  <select class="input select" [(ngModel)]="editFields.type" name="editType{{i}}">
                    <option *ngFor="let t of workoutTypes" [value]="t">{{ t }}</option>
                  </select>
                  <textarea class="input textarea" rows="2" [(ngModel)]="editFields.notes" name="editNotes{{i}}" placeholder="Notas"></textarea>
                </div>
                <div class="edit-actions">
                  <button mat-raised-button color="primary" (click)="saveEditedWorkout()">
                    <mat-icon>save</mat-icon>
                    Guardar cambios
                  </button>
                  <button mat-stroked-button (click)="cancelEdit()">
                    <mat-icon>close</mat-icon>
                    Cancelar
                  </button>
                </div>
              </div>
            </div>
          </mat-expansion-panel>
        </mat-accordion>
      </div>
      </ng-template>
    </mat-tab>

    <!-- Charts Tab -->
    <mat-tab label="Analytics">
      <ng-template matTabContent>
        <app-progress-charts></app-progress-charts>
      </ng-template>
    </mat-tab>

    <!-- Before & After Tab -->
    <mat-tab label="Before & After">
      <ng-template matTabContent>
        <app-before-after></app-before-after>
      </ng-template>
    </mat-tab>
  </mat-tab-group>

  <!-- Loading state -->
  <div class="loading-state" *ngIf="loading">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading your progress...</p>
  </div>
</div>

