<div class="nutrition-page">
  <!-- Header -->
  <header class="page-header">
    <div class="header-content">
      <div class="header-text">
        <p class="eyebrow">{{ isExamplePlan ? 'Plan de ejemplo' : 'Tu plan personalizado' }}</p>
        <h1>{{ plan?.name || 'Plan Nutricional' }}</h1>
        <p class="subtitle" *ngIf="plan?.description">{{ plan?.description }}</p>
      </div>
      <button class="chat-toggle" (click)="toggleChat()" [class.has-unread]="unreadCount > 0">
        <mat-icon>chat</mat-icon>
        <span class="unread-badge" *ngIf="unreadCount > 0">{{ unreadCount }}</span>
      </button>
    </div>
  </header>

  <!-- Loading -->
  <div class="loading-container" *ngIf="loading">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <!-- Example Plan Banner -->
  <div class="example-banner" *ngIf="!loading && isExamplePlan">
    <mat-icon>lightbulb</mat-icon>
    <div class="banner-text">
      <strong>Plan de ejemplo</strong>
      <span>Esto es orientativo. Tu coach lo personalizará según tus objetivos.</span>
    </div>
    <button class="banner-btn" (click)="toggleChat()">
      <mat-icon>chat</mat-icon>
      Solicitar plan
    </button>
  </div>

  <!-- Plan Content -->
  <div class="plan-content" *ngIf="!loading && plan">
    <!-- Macros Summary -->
    <section class="macros-section">
      <div class="macros-grid">
        <div class="macro-card calories">
          <div class="macro-icon"><mat-icon>local_fire_department</mat-icon></div>
          <div class="macro-info">
            <span class="macro-value">{{ plan.daily_calories || '-' }}</span>
            <span class="macro-label">kcal/día</span>
          </div>
        </div>
        <div class="macro-card protein">
          <div class="macro-icon"><mat-icon>egg</mat-icon></div>
          <div class="macro-info">
            <span class="macro-value">{{ plan.protein_grams || '-' }}g</span>
            <span class="macro-label">Proteína</span>
          </div>
        </div>
        <div class="macro-card carbs">
          <div class="macro-icon"><mat-icon>grain</mat-icon></div>
          <div class="macro-info">
            <span class="macro-value">{{ plan.carbs_grams || '-' }}g</span>
            <span class="macro-label">Carbos</span>
          </div>
        </div>
        <div class="macro-card fat">
          <div class="macro-icon"><mat-icon>water_drop</mat-icon></div>
          <div class="macro-info">
            <span class="macro-value">{{ plan.fat_grams || '-' }}g</span>
            <span class="macro-label">Grasas</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Week Calendar -->
    <section class="calendar-section">
      <div class="week-selector">
        <button 
          *ngFor="let day of days" 
          class="day-btn"
          [class.active]="selectedDay === day"
          [class.today]="isToday(day)"
          (click)="selectDay(day)"
        >
          <span class="day-short">{{ dayShortLabels[day] }}</span>
          <span class="day-full">{{ dayLabels[day] }}</span>
          <span class="day-indicator" *ngIf="isToday(day)"></span>
        </button>
      </div>

      <!-- Day Stats -->
      <div class="day-stats">
        <div class="day-title">
          <h2>{{ dayLabels[selectedDay] }}</h2>
          <span class="today-badge" *ngIf="isToday(selectedDay)">Hoy</span>
        </div>
        <div class="day-macros">
          <span class="dm-item cal">{{ getDayTotals(selectedDay).calories }} kcal</span>
          <span class="dm-item pro">P: {{ getDayTotals(selectedDay).protein }}g</span>
          <span class="dm-item car">C: {{ getDayTotals(selectedDay).carbs }}g</span>
          <span class="dm-item fat">G: {{ getDayTotals(selectedDay).fat }}g</span>
        </div>
      </div>

      <!-- Meals for Selected Day -->
      <div class="meals-grid">
        <div class="meal-card" *ngFor="let meal of getMealsForSelectedDay(); trackBy: trackByMeal">
          <div class="meal-header">
            <div class="meal-type">
              <mat-icon>{{ mealTypeIcons[meal.meal_type] || 'restaurant' }}</mat-icon>
              <span>{{ mealTypeLabels[meal.meal_type] || meal.meal_type }}</span>
            </div>
            <span class="meal-time" *ngIf="meal.time_suggestion">{{ meal.time_suggestion }}</span>
          </div>
          
          <h3 class="meal-name">{{ meal.name }}</h3>
          
          <!-- Foods list -->
          <div class="foods-list" *ngIf="meal.foods && meal.foods.length > 0">
            <div class="food-item" *ngFor="let food of meal.foods">
              <span class="food-name">{{ food.name }}</span>
              <span class="food-portion">{{ food.portion }}</span>
            </div>
          </div>
          
          <!-- Meal macros -->
          <div class="meal-macros">
            <span class="mm-cal">{{ meal.calories || 0 }} kcal</span>
            <span class="mm-pro">P: {{ meal.protein_grams || 0 }}g</span>
            <span class="mm-car">C: {{ meal.carbs_grams || 0 }}g</span>
            <span class="mm-fat">G: {{ meal.fat_grams || 0 }}g</span>
          </div>
        </div>

        <div class="no-meals" *ngIf="getMealsForSelectedDay().length === 0">
          <mat-icon>restaurant_menu</mat-icon>
          <p>No hay comidas para este día</p>
        </div>
      </div>
    </section>

    <!-- Notes -->
    <section class="notes-section" *ngIf="plan.notes">
      <div class="notes-card">
        <div class="notes-header">
          <mat-icon>sticky_note_2</mat-icon>
          <span>Notas del plan</span>
        </div>
        <p>{{ plan.notes }}</p>
      </div>
    </section>
  </div>

  <!-- Chat Panel -->
  <div class="chat-overlay" *ngIf="showChat" (click)="toggleChat()">
    <div class="chat-panel" (click)="$event.stopPropagation()">
      <div class="chat-header">
        <div class="chat-title">
          <mat-icon>support_agent</mat-icon>
          <span>Chat con tu Coach</span>
        </div>
        <button class="close-btn" (click)="toggleChat()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="chat-messages" #chatContainer>
        <div class="chat-loading" *ngIf="chatLoading">
          <mat-spinner diameter="30"></mat-spinner>
        </div>

        <div class="no-messages" *ngIf="!chatLoading && messages.length === 0">
          <mat-icon>chat_bubble_outline</mat-icon>
          <p>Envía un mensaje a tu coach para personalizar tu plan</p>
        </div>

        <div class="message" 
             *ngFor="let msg of messages; trackBy: trackByMessage"
             [class.own]="msg.sender_role === 'user'"
             [class.coach]="msg.sender_role === 'coach'">
          <div class="message-content">
            <p>{{ msg.message }}</p>
            <span class="message-time">{{ formatDate(msg.created_at!) }}</span>
          </div>
        </div>
      </div>

      <div class="chat-input">
        <input 
          type="text" 
          [(ngModel)]="newMessage" 
          placeholder="Escribe tu mensaje..."
          (keyup.enter)="sendMessage()"
          [disabled]="sendingMessage"
        />
        <button class="send-btn" (click)="sendMessage()" [disabled]="!newMessage.trim() || sendingMessage">
          <mat-icon>send</mat-icon>
        </button>
      </div>
    </div>
  </div>
</div>
